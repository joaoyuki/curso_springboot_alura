<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Aula 06 - Restringindo acesso aos endpoints privados</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
  
    <script type="text/javascript">
        function in_frame () { try { return window.self !== window.top; } catch (e) { return true; } }
        if (!in_frame()) {
            var page = location.pathname.substring(location.pathname.lastIndexOf("/") + 1);
            window.location = 'index.html#' + page;
        }
    </script>
</head>
<body><div class="page"><h1 class="title">Aula 06 - Restringindo acesso aos endpoints privados</h1><br/>Precisamos indicar ao spring qual é a nossa classe que vai representar o usuário da aplicação, para isso, precisamos implementar a interface UserDetails e implementar seus métodos:<br /><br /><div class="codebox"><div class="codebox">@Entity<br /><span style="color:#2e8b57;font-weight:700">public</span>&nbsp;<span style="color:#2e8b57;font-weight:700">class</span>&nbsp;Usuario&nbsp;<span style="color:#2e8b57;font-weight:700">implements</span>&nbsp;UserDetails{<br /><br />	@Id&nbsp;@GeneratedValue(strategy&nbsp;=&nbsp;GenerationType.IDENTITY)<br />	<span style="color:#2e8b57;font-weight:700">private</span>&nbsp;Long&nbsp;id;<br />	<span style="color:#2e8b57;font-weight:700">private</span>&nbsp;String&nbsp;nome;<br />	<span style="color:#2e8b57;font-weight:700">private</span>&nbsp;String&nbsp;email;<br />	<span style="color:#2e8b57;font-weight:700">private</span>&nbsp;String&nbsp;senha;<br />	<br />	@ManyToMany(fetch&nbsp;=&nbsp;FetchType.EAGER)<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2e8b57;font-weight:700">private</span>&nbsp;List&lt;Perfil&gt;&nbsp;perfis&nbsp;=&nbsp;<span style="color:#a52a2a;font-weight:700">new</span>&nbsp;ArrayList&lt;&gt;();<br /><br />	@Override<br />	<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;<span style="color:#2e8b57;font-weight:700">int</span>&nbsp;hashCode()&nbsp;{<br />		<span style="color:#2e8b57;font-weight:700">final</span>&nbsp;<span style="color:#2e8b57;font-weight:700">int</span>&nbsp;prime&nbsp;=&nbsp;<span style="color:#ff00ff;font-weight:400">31</span>;<br />		<span style="color:#2e8b57;font-weight:700">int</span>&nbsp;result&nbsp;=&nbsp;<span style="color:#ff00ff;font-weight:400">1</span>;<br />		result&nbsp;=&nbsp;prime&nbsp;*&nbsp;result&nbsp;+&nbsp;((id&nbsp;==&nbsp;<span style="color:#ff00ff;font-weight:400">null</span>)&nbsp;?&nbsp;<span style="color:#ff00ff;font-weight:400">0</span>&nbsp;:&nbsp;id.hashCode());<br />		<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;result;<br />	}<br /><br />	@Override<br />	<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;<span style="color:#2e8b57;font-weight:700">boolean</span>&nbsp;equals(Object&nbsp;obj)&nbsp;{<br />		<span style="color:#a52a2a;font-weight:700">if</span>&nbsp;(<span style="color:#a52a2a;font-weight:700">this</span>&nbsp;==&nbsp;obj)<br />			<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;<span style="color:#ff00ff;font-weight:400">true</span>;<br />		<span style="color:#a52a2a;font-weight:700">if</span>&nbsp;(obj&nbsp;==&nbsp;<span style="color:#ff00ff;font-weight:400">null</span>)<br />			<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;<span style="color:#ff00ff;font-weight:400">false</span>;<br />		<span style="color:#a52a2a;font-weight:700">if</span>&nbsp;(getClass()&nbsp;!=&nbsp;obj.getClass())<br />			<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;<span style="color:#ff00ff;font-weight:400">false</span>;<br />		Usuario&nbsp;other&nbsp;=&nbsp;(Usuario)&nbsp;obj;<br />		<span style="color:#a52a2a;font-weight:700">if</span>&nbsp;(id&nbsp;==&nbsp;<span style="color:#ff00ff;font-weight:400">null</span>)&nbsp;{<br />			<span style="color:#a52a2a;font-weight:700">if</span>&nbsp;(other.id&nbsp;!=&nbsp;<span style="color:#ff00ff;font-weight:400">null</span>)<br />				<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;<span style="color:#ff00ff;font-weight:400">false</span>;<br />		}&nbsp;<span style="color:#a52a2a;font-weight:700">else</span>&nbsp;<span style="color:#a52a2a;font-weight:700">if</span>&nbsp;(!id.equals(other.id))<br />			<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;<span style="color:#ff00ff;font-weight:400">false</span>;<br />		<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;<span style="color:#ff00ff;font-weight:400">true</span>;<br />	}<br /><br />	<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;Long&nbsp;getId()&nbsp;{<br />		<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;id;<br />	}<br /><br />	<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;<span style="color:#2e8b57;font-weight:700">void</span>&nbsp;setId(Long&nbsp;id)&nbsp;{<br />		<span style="color:#a52a2a;font-weight:700">this</span>.id&nbsp;=&nbsp;id;<br />	}<br /><br />	<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;String&nbsp;getNome()&nbsp;{<br />		<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;nome;<br />	}<br /><br />	<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;<span style="color:#2e8b57;font-weight:700">void</span>&nbsp;setNome(String&nbsp;nome)&nbsp;{<br />		<span style="color:#a52a2a;font-weight:700">this</span>.nome&nbsp;=&nbsp;nome;<br />	}<br /><br />	<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;String&nbsp;getEmail()&nbsp;{<br />		<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;email;<br />	}<br /><br />	<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;<span style="color:#2e8b57;font-weight:700">void</span>&nbsp;setEmail(String&nbsp;email)&nbsp;{<br />		<span style="color:#a52a2a;font-weight:700">this</span>.email&nbsp;=&nbsp;email;<br />	}<br /><br />	<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;String&nbsp;getSenha()&nbsp;{<br />		<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;senha;<br />	}<br /><br />	<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;<span style="color:#2e8b57;font-weight:700">void</span>&nbsp;setSenha(String&nbsp;senha)&nbsp;{<br />		<span style="color:#a52a2a;font-weight:700">this</span>.senha&nbsp;=&nbsp;senha;<br />	}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;@Override<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;Collection&lt;?&nbsp;<span style="color:#2e8b57;font-weight:700">extends</span>&nbsp;GrantedAuthority&gt;&nbsp;getAuthorities()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;<span style="color:#a52a2a;font-weight:700">this</span>.perfis;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;@Override<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;String&nbsp;getPassword()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;<span style="color:#a52a2a;font-weight:700">this</span>.senha;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;@Override<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;String&nbsp;getUsername()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;<span style="color:#a52a2a;font-weight:700">this</span>.email;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;font-weight:400">//&nbsp;Deixamos&nbsp;tudo&nbsp;como&nbsp;TRUE&nbsp;pois&nbsp;não&nbsp;iremos&nbsp;fazer&nbsp;esses&nbsp;controles&nbsp;por&nbsp;enquanto</span><br />&nbsp;&nbsp;&nbsp;&nbsp;@Override<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;<span style="color:#2e8b57;font-weight:700">boolean</span>&nbsp;isAccountNonExpired()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;<span style="color:#ff00ff;font-weight:400">true</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;@Override<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;<span style="color:#2e8b57;font-weight:700">boolean</span>&nbsp;isAccountNonLocked()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;<span style="color:#ff00ff;font-weight:400">true</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;@Override<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;<span style="color:#2e8b57;font-weight:700">boolean</span>&nbsp;isCredentialsNonExpired()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;<span style="color:#ff00ff;font-weight:400">true</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;@Override<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;<span style="color:#2e8b57;font-weight:700">boolean</span>&nbsp;isEnabled()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;<span style="color:#ff00ff;font-weight:400">true</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />}<br /></div></div><br /><br />Após configurar o usuário e o perfil, precisamos adicionar mais algumas condifurações na nossa de configuração:<br /><br /><div class="codebox"><div class="codebox">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;font-weight:400">//&nbsp;Configurações&nbsp;de&nbsp;autorização&nbsp;(Quem&nbsp;pode&nbsp;acessar&nbsp;cada&nbsp;URL&nbsp;/&nbsp;perfil&nbsp;de&nbsp;acesso)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;@Override<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2e8b57;font-weight:700">protected</span>&nbsp;<span style="color:#2e8b57;font-weight:700">void</span>&nbsp;configure(HttpSecurity&nbsp;http)&nbsp;<span style="color:#2e8b57;font-weight:700">throws</span>&nbsp;Exception&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.authorizeRequests()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.antMatchers(HttpMethod.GET,&nbsp;<span style="color:#ff00ff;font-weight:400">"/topicos"</span>).permitAll()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.antMatchers(HttpMethod.GET,&nbsp;<span style="color:#ff00ff;font-weight:400">"/topicos/*"</span>).permitAll()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.anyRequest().authenticated()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.and().formLogin()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /></div></div><br /><br />• .anyRequest().authenticated() diz que qualquer requisição fora as URL's especificadas, devem ser autenticadas<br />• .and() adiciona mais configurações<br />• .formLogin() indica para o spring usar o formulário e controller de autenticação do próprio spring<br /><br />Ao tentarmos acessar <a href="http://localhost:8080/">http://localhost:8080/</a> veremos a seguinte tela:<br /><br /><img src="images\22-1.png" alt="images\22-1.png" /><br /><br /></div></body></html>