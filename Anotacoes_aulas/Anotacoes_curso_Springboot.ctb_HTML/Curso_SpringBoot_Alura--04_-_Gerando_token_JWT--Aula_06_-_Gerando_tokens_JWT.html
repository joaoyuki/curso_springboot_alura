<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Aula 06 - Gerando tokens JWT</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
  
    <script type="text/javascript">
        function in_frame () { try { return window.self !== window.top; } catch (e) { return true; } }
        if (!in_frame()) {
            var page = location.pathname.substring(location.pathname.lastIndexOf("/") + 1);
            window.location = 'index.html#' + page;
        }
    </script>
</head>
<body><div class="page"><h1 class="title">Aula 06 - Gerando tokens JWT</h1><br/>Para fazer a autenticação manual do spring, precisamos utilizar a classe AuthenticationManager<br />    <br />    // Essa classe não faz a própria injeção de dependência<br />    @Autowired<br />    private AuthenticationManager authenticationManager;<br />    <br />A nossa sorte é que a classe que extendemos na nossa classe de configuração do SpringSecurity ( <strong>SecurityConfiguration</strong> extends <strong>WebSecurityConfigurerAdapter</strong> ) já tem um método que cria esse authenticationManager, basta sobrescrevermos o método:<br /><br /><div class="codebox"><div class="codebox">@EnableWebSecurity&nbsp;<span style="color:#0000ff;font-weight:400">//&nbsp;Habilita&nbsp;o&nbsp;módulo&nbsp;de&nbsp;segurança&nbsp;na&nbsp;aplicação</span><br />@Configuration&nbsp;<span style="color:#0000ff;font-weight:400">//&nbsp;Indica&nbsp;que&nbsp;essa&nbsp;classe&nbsp;vai&nbsp;possuir&nbsp;configurações&nbsp;do&nbsp;Spring.&nbsp;Assim&nbsp;ao&nbsp;iniciar&nbsp;o&nbsp;projeto,&nbsp;o&nbsp;spring&nbsp;lê&nbsp;as&nbsp;configurações&nbsp;dessa&nbsp;classe</span><br /><span style="color:#2e8b57;font-weight:700">public</span>&nbsp;<span style="color:#2e8b57;font-weight:700">class</span>&nbsp;SecurityConfiguration&nbsp;<span style="color:#2e8b57;font-weight:700">extends</span>&nbsp;WebSecurityConfigurerAdapter{<br /><br />.....&nbsp;código<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;@Override<br />&nbsp;&nbsp;&nbsp;&nbsp;@Bean&nbsp;<span style="color:#0000ff;font-weight:400">//&nbsp;Indica&nbsp;para&nbsp;o&nbsp;spring&nbsp;que&nbsp;esse&nbsp;método&nbsp;devolve&nbsp;o&nbsp;authenticationManager,&nbsp;e&nbsp;assim,&nbsp;conseguimos&nbsp;injetar</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2e8b57;font-weight:700">protected</span>&nbsp;AuthenticationManager&nbsp;authenticationManager()&nbsp;<span style="color:#2e8b57;font-weight:700">throws</span>&nbsp;Exception&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;<span style="color:#a52a2a;font-weight:700">super</span>.authenticationManager();<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />.....&nbsp;código<br /><br />}</div></div><br /><br />Agora podemos utilizar essa classe do spring para validar o usuário e senha.<br /><br />Agora vamos implementar a validação do usuário e a geração do token:<br /><br /><div class="codebox"><div class="codebox">@RestController<br />@RequestMapping(<span style="color:#ff00ff;font-weight:400">"/auth"</span>)<br /><span style="color:#2e8b57;font-weight:700">public</span>&nbsp;<span style="color:#2e8b57;font-weight:700">class</span>&nbsp;AutenticacaoController&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;@Autowired<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2e8b57;font-weight:700">private</span>&nbsp;AuthenticationManager&nbsp;authenticationManager;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;@Autowired<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2e8b57;font-weight:700">private</span>&nbsp;TokenService&nbsp;tokenService;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;@PostMapping<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;ResponseEntity&nbsp;autenticar(@RequestBody&nbsp;@Valid&nbsp;LoginForm&nbsp;form)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a52a2a;font-weight:700">try</span>&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UsernamePasswordAuthenticationToken&nbsp;dadosLogin&nbsp;=&nbsp;form.converter();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2e8b57;font-weight:700">final</span>&nbsp;Authentication&nbsp;authenticate&nbsp;=&nbsp;authenticationManager.authenticate(dadosLogin);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;token&nbsp;=&nbsp;tokenService.gerarToken(authenticate);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(token);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;ResponseEntity.ok().build();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color:#a52a2a;font-weight:700">catch</span>&nbsp;(AuthenticationException&nbsp;e)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;ResponseEntity.badRequest().build();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />}<br /></div></div><br /><br /><div class="codebox"><div class="codebox"><span style="color:#0000ff;font-weight:400">/**<br />&nbsp;*<br />&nbsp;*&nbsp;@author&nbsp;João<br />&nbsp;*/</span><br />@Service<br /><span style="color:#2e8b57;font-weight:700">public</span>&nbsp;<span style="color:#2e8b57;font-weight:700">class</span>&nbsp;TokenService&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;@Value(<span style="color:#ff00ff;font-weight:400">"${forum.jwt.expiration}"</span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2e8b57;font-weight:700">private</span>&nbsp;String&nbsp;expiration;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;@Value(<span style="color:#ff00ff;font-weight:400">"${forum.jwt.secret}"</span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2e8b57;font-weight:700">private</span>&nbsp;String&nbsp;secret;&nbsp;&nbsp;&nbsp;&nbsp;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2e8b57;font-weight:700">public</span>&nbsp;String&nbsp;gerarToken(Authentication&nbsp;authenticate)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Usuario&nbsp;usuarioLogado&nbsp;=&nbsp;(Usuario)&nbsp;authenticate.getPrincipal();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Date&nbsp;hoje&nbsp;=&nbsp;<span style="color:#a52a2a;font-weight:700">new</span>&nbsp;Date();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Date&nbsp;dataExpiracao&nbsp;=&nbsp;<span style="color:#a52a2a;font-weight:700">new</span>&nbsp;Date(hoje.getTime()&nbsp;+&nbsp;Long.parseLong(expiration));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a52a2a;font-weight:700">return</span>&nbsp;Jwts.builder()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.setIssuer(<span style="color:#ff00ff;font-weight:400">"API&nbsp;do&nbsp;Forum"</span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.setSubject(usuarioLogado.getId().toString())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.setIssuedAt(hoje)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.setExpiration(dataExpiracao)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.signWith(SignatureAlgorithm.HS256,&nbsp;secret)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.compact()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />}<br /></div></div><br /><br /></div></body></html>